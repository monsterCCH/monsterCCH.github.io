---
layout: wiki
title: valgrind 使用教程
categories: debug
description: valgrind 使用教程
keywords: valgrind
---

## 概述
Valgrind是一种开源工具套件，旨在帮助开发人员调试、分析和优化程序的内存使用和执行性能。它由Valgrind开发团队开发，最初是为Linux操作系统开发的，但现在也可用于其他操作系统，如macOS和Android。 Valgrind包括多个工具，包括Memcheck、Cachegrind、Callgrind、Helgrind、DRD、Massif等。这些工具可用于检测内存泄漏、越界读写、未初始化变量、线程竞争、函数调用关系、缓存使用情况、内存使用情况等问题。这些问题通常是程序崩溃或性能下降的主要原因。Valgrind的主要优点是它可以帮助开发人员快速找到并解决程序中的内存和性能问题。它是开发和测试过程中的有用工具，特别是对于大型和复杂的代码库。缺点是Valgrind会降低程序的性能，因此不建议在生产环境中使用它。

### Memcheck
Valgrind最常用的工具之一。它通过在程序执行期间检查内存使用情况，找出内存泄漏和内存错误。它可以检测到未初始化的变量、越界读写、使用已释放的内存、重复释放内存等问题。

### Cachegrind和Callgrind
用于分析程序性能的工具。它们可以帮助您找出程序中的性能瓶颈，了解程序在缓存中的数据访问情况，并分析函数调用关系。

### Helgrind和DRD
是用于检测线程问题的工具。它们可以检测出线程竞争、死锁等问题，帮助您确保程序在多线程环境中的稳定性和正确性。

### Massif
Valgrind工具集中的一个内存分析器，可以帮助开发人员了解程序的内存使用情况。与Memcheck工具不同，Massif不仅可以检测内存泄漏和内存错误，还可以测量程序在堆上分配的内存量，以及内存分配的位置和时间。 

### extend

#### dhat
Dhat是Valgrind工具集中的一个工具，用于检测程序中动态内存使用的问题。它专门用于检测动态内存分配和释放时的错误，例如悬挂指针、内存泄漏和越界访问等问题。

Dhat的工作原理是对程序执行过程中动态分配的内存进行跟踪和统计。它会记录每个内存块的地址、大小和分配情况，并在程序退出时生成内存使用报告。该报告会显示程序中分配的每个内存块的详细信息，包括分配和释放的时间、大小、地址等等。

与Memcheck工具不同，Dhat只会检测动态分配的内存使用情况，而不会检测静态分配的内存或全局变量的使用情况。因此，Dhat适用于对动态内存分配进行深入分析的场景，例如需要检测内存泄漏或其他动态内存相关问题的场景

#### exp-bbv
exp-bbv是Valgrind工具集中的一个工具，用于检测程序中的布尔矢量错误。它可以检测程序中使用的布尔矢量的错误，例如未初始化、越界访问、非法访问等问题。

exp-bbv的工作原理是对程序执行过程中使用的布尔矢量进行跟踪和分析。它会记录每个布尔矢量的使用情况，并在程序退出时生成报告。该报告会显示程序中使用的每个布尔矢量的详细信息，包括使用次数、初始化情况、越界访问等等。

#### getoff
getoff是Valgrind工具集中的一个工具，用于帮助开发人员调试程序中的汇编代码。它可以分析程序中的汇编代码，提供有关指令执行的详细信息，包括寄存器值、内存地址和指令流等等。

getoff的工作原理是在程序执行过程中，通过Valgrind工具来获取程序中指令的执行情况。它会记录每个指令的执行情况，并在程序退出时生成报告。该报告会显示程序中每个指令的详细信息，包括指令的地址、寄存器值、内存地址、指令流等等。

需要注意的是，getoff工具对程序性能有一定影响，因此在使用时需要评估程序的性能，并考虑是否需要使用该工具进行调试。此外，由于getoff工具需要分析程序的汇编代码，因此只适用于对程序的底层细节进行深入分析的场景，一般情况下不需要使用该工具

#### lackey
lackey是Valgrind工具集中的一个工具，用于帮助开发人员调试和分析多线程程序中的同步问题。它可以检测多线程程序中的同步错误，如竞态条件、死锁、饥饿等等。

lackey的工作原理是通过记录程序中每个线程的执行情况，分析线程之间的交互情况，从而发现同步问题。具体来说，lackey会跟踪程序中每个线程的执行情况，并记录线程间的互相等待、互相通知等等情况。当程序出现同步问题时，lackey会生成报告，并提示开发人员问题所在的位置。

## 安装
Valgrind是一个在Linux系统上运行的工具，因此您需要在Linux系统上安装Valgrind。在大多数Linux发行版中，您可以使用包管理器来安装Valgrind。例如，在Ubuntu上，您可以使用以下命
令来安装Valgrind：

`sudo apt-get install valgrind`

如果您使用的是其他Linux发行版，请参考其官方文档来安装Valgrind。

## Valgrind工具集概览
Valgrind工具集包含以下几个主要工具：

* Memcheck：用于检测内存泄漏、内存错误等问题。
* Cachegrind：用于检测程序中的缓存命中率、分支预测错误等问题。
* Callgrind：用于生成函数调用图和性能分析报告。
* Helgrind：用于检测多线程程序中的竞争条件、死锁等问题。
* DRD：用于检测多线程程序中的并发错误。
* Massif：用于检测程序中的内存使用情况。
在本教程中，我们将介绍如何使用Memcheck、Cachegrind和Massif这三个工具。其他工具的使用方法与这些工具类似。

## 使用说明
编译程序时加入 `–g -fno-inline` 编译选项保留调试信息，否则 valgrind 不能显示到出错行号。

valgrind被设计成非侵入式的，它直接工作于可执行文件上，因此在检查前不需要重新编译、连接和修改你的程序。要检查一个程序很简单，只需要执行下面的命令就可以了
```shell
valgrind --tool=<tool_name> program_name
# such as
valgrind --tool=memcheck ls -l
```
tips:
如果不知道有哪些参数, 可以先输入valgrind –tool=, 然后狂按两次tab, 支持的linux会自动补全, 同样,如果你输入了valgrind –tool=mem再狂按两次tab,linux系统会为你自动补全

### 使用Memcheck
Memcheck是Valgrind工具集中最常用的工具之一，可以帮助开发人员检测内存泄漏、内存错误等问题。下面是使用Memcheck的步骤：

#### 编译您的程序时，使用-g选项启用调试信息。

#### 使用以下命令运行程序：
```shell
valgrind --tool=memcheck –leak-check=full –show-reachable=yes –trace-children=yes ./my_program
```
其中–leak-check=full 指的是完全检查内存泄漏，

–show-reachable=yes是显示内存泄漏的地点，

–trace-children=yes是跟入子进程。

此命令将启动Memcheck，并在程序运行结束后生成内存检测报告。

#### 查看报告并解决问题。
Memcheck报告会显示程序中的每个内存分配和释放，以及任何未初始化的内存读取和内存泄漏。您可以使用命令行或图形化工具来查看报告，并找出程序中的内存使用问题。根据报告的输出，您可以修改代码以修复问题。

### 使用Cachegrind
Cachegrind是Valgrind工具集中的另一个工具，可以帮助开发人员检测程序中的缓存命中率、分支预测错误等问题。下面是使用Cachegrind的步骤：

#### 编译您的程序时，使用-g选项启用调试信息。

#### 使用以下命令运行程序：
```shell
valgrind --tool=cachegrind ./my_program
```
此命令将启动Cachegrind，并在程序运行结束后生成缓存分析报告。

#### 查看报告并解决问题。
Cachegrind报告会显示程序中的每个指令和数据访问，以及缓存命中率、缓存大小和分支预测错误等信息。您可以使用命令行或图形化工具来查看报告，并找出程序中的性能问题。根据报告的输出，您可以修改代码以改进程序的性能。

### 使用Massif
Massif是Valgrind工具集中的另一个工具，可以帮助开发人员检测程序中的内存使用情况。下面是使用Massif的步骤：

#### 编译您的程序时，使用-g选项启用调试信息。

#### 使用以下命令运行程序：
```shell
valgrind --tool=massif ./my_program
```
此命令将启动Massif，并在程序运行结束后生成内存使用报告。

#### 查看报告并解决问题。
Massif报告会显示程序中每个堆栈帧的内存使用情况，以及程序中的堆大小和堆分配情况。您可以使用命令行或图形化工具来查看报告，并找出程序中的内存使用问题。根据报告的输出，您可以修改代码以改进程序的内存使用效率。

### 其他Valgrind工具的使用
除了Memcheck、Cachegrind和Massif之外，Valgrind工具集还包括其他有用的工具，例如Callgrind、Helgrind和DRD等。这些工具使用方法类似于本教程中介绍的工具，只需要将工具名称替换为所需工具的名称即可。例如，要使用Callgrind来生成函数调用图和性能分析报告，请使用以下命令：
```shell
valgrind --tool=callgrind ./my_program
```
此命令将启动Callgrind，并在程序运行结束后生成性能分析报告。

## 总结
Valgrind是一个非常强大的工具，可以帮助开发人员检测和解决程序中的各种问题。在本教程中，我们介绍了Valgrind工具集的主要工具和使用方法。请记住，Valgrind是一款非常灵活和定制化的工具，可以根据您的需要进行各种配置和调整。祝您使用Valgrind愉快！
